<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi √Ålbum de Fotos</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#3a4254; --text:#e7ebf3; --accent:#7aa2f7; --accent-2:#9ece6a; --danger:#f7768e;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text)}

    .app{display:grid; grid-template-columns:280px 1fr; grid-template-rows:auto 1fr; height:100vh}
    header{grid-column:1/3; display:flex; gap:10px; align-items:center; padding:12px 16px; background:linear-gradient(180deg, rgba(255,255,255,.04), transparent); border-bottom:1px solid #222630; position:sticky; top:0; z-index:5}
    header h1{margin:0; font-size:18px; letter-spacing:.3px}
    header .spacer{flex:1}

    .btn{border:1px solid #2a3140; background:#1a1e27; color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; display:inline-flex; align-items:center; gap:8px}
    .btn:hover{border-color:#3a4254}
    .btn.primary{background:var(--accent); color:#0b1020; border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.danger{background:transparent; border-color:#4a2030; color:#ff8fa3}

    .sidebar{border-right:1px solid #222630; background:var(--panel); padding:14px; overflow:auto}
    .sidebar h2{margin:6px 0 10px; font-size:13px; opacity:.8}
    .album-list{display:flex; flex-direction:column; gap:6px}
    .album{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-radius:10px; cursor:pointer; border:1px solid transparent}
    .album.active{background:#11141a; border-color:#2c3342}
    .album .name{font-weight:600}
    .album small{opacity:.6}

    .new-album{display:flex; gap:8px; margin-top:10px}
    .input{background:#0e121a; border:1px solid #262c39; border-radius:10px; color:var(--text); padding:10px 12px; outline:none}
    .input:focus{border-color:#3b82f6}

    .main{padding:16px; overflow:auto}
    .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:12px}
    .dropzone{border:1.8px dashed #2a3140; background:#0d1016; border-radius:var(--radius); padding:20px; display:flex; gap:12px; align-items:center}
    .dropzone.dragover{border-color:var(--accent); background:rgba(122,162,247,.08)}
    .search{min-width:220px}
    .select{appearance:none; background:#0e121a; border:1px solid #262c39; color:var(--text); border-radius:10px; padding:10px 12px}

    .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:12px}
    .card{position:relative; border-radius:14px; overflow:hidden; background:#0b0e14; border:1px solid #232a38}
    .thumb{aspect-ratio:1/1; width:100%; object-fit:cover; display:block}
    .card .meta{position:absolute; bottom:0; left:0; right:0; padding:8px; background:linear-gradient(180deg, transparent, rgba(0,0,0,.6)); display:flex; justify-content:space-between; align-items:end}
    .chip{background:rgba(0,0,0,.45); padding:4px 8px; border-radius:999px; font-size:12px}

    dialog{border:none; border-radius:14px; padding:0; overflow:hidden; background:#0c0f15; color:var(--text); width:min(92vw, 980px)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .lightbox{display:grid; grid-template-columns:1fr 320px; gap:0}
    .lightbox .media{background:#0b0e14; display:flex; align-items:center; justify-content:center; min-height:60vh}
    .lightbox img{max-width:100%; max-height:75vh}
    .lightbox .side{border-left:1px solid #222630; padding:14px; display:flex; flex-direction:column; gap:10px}
    .row{display:flex; gap:8px; align-items:center}
    .row.wrap{flex-wrap:wrap}
    .tags{display:flex; gap:6px; flex-wrap:wrap}

    .empty{opacity:.7; border:1px dashed #2a3140; border-radius:14px; padding:24px; text-align:center}

    .footer{display:flex; justify-content:space-between; align-items:center; padding:10px 14px; border-top:1px solid #222630; background:#0d1118}
    .link{color:var(--accent); text-decoration:none}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üì∏ Mi √Ålbum de Fotos</h1>
      <div class="spacer"></div>
      <button class="btn ghost" id="btn-export" title="Exportar respaldo (JSON)">Exportar</button>
      <label class="btn ghost" for="import-input" title="Importar respaldo (JSON)">Importar</label>
      <input id="import-input" type="file" accept="application/json" hidden />
      <button class="btn primary" id="btn-add" title="Agregar fotos">Subir fotos</button>
      <input id="file-input" type="file" accept="image/*" multiple hidden />
    </header>

    <aside class="sidebar">
      <h2>√Ålbumes</h2>
      <div class="album-list" id="album-list"></div>
      <div class="new-album">
        <input id="new-album-name" class="input" placeholder="Nuevo √°lbum" />
        <button class="btn" id="create-album">Crear</button>
      </div>
    </aside>

    <main class="main">
      <div class="toolbar">
        <div class="dropzone" id="dropzone">
          <strong>Arrastra tus fotos aqu√≠</strong>
          <span style="opacity:.7">o usa ‚ÄúSubir fotos‚Äù</span>
        </div>
        <input id="search" class="input search" placeholder="Buscar por nombre o etiqueta" />
        <select id="sort" class="select">
          <option value="newest">M√°s recientes</option>
          <option value="oldest">M√°s antiguas</option>
          <option value="name">Nombre (A-Z)</option>
        </select>
      </div>

      <section id="grid" class="grid"></section>
      <div id="empty" class="empty" style="display:none">A√∫n no hay fotos en este √°lbum.</div>
    </main>
  </div>

  <dialog id="viewer">
    <div class="lightbox">
      <div class="media"><img id="viewer-img" alt="" /></div>
      <div class="side">
        <div class="row wrap"><button class="btn" id="prev">‚óÄ</button><button class="btn" id="next">‚ñ∂</button><button class="btn" id="download">Descargar</button><button class="btn danger" id="delete">Eliminar</button></div>
        <label>Nombre<input id="edit-name" class="input" /></label>
        <label>√Ålbum<select id="edit-album" class="select"></select></label>
        <label>Etiquetas (separadas por coma)<input id="edit-tags" class="input" placeholder="familia, viaje" /></label>
        <div class="row wrap">
          <button class="btn primary" id="save">Guardar cambios</button>
          <span style="opacity:.7" id="meta"></span>
        </div>
      </div>
    </div>
  </dialog>

  <footer class="footer">
    <small>Los datos se guardan en tu navegador (IndexedDB). Exporta un respaldo para no perderlos.</small>
    <a class="link" href="#" id="clear-all">Borrar todo</a>
  </footer>

<script>
// ======= Utilidades UI =======
const $ = (s, el=document) => el.querySelector(s);
const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
const toast = (msg) => { console.log(msg); };

// ======= IndexedDB simple =======
const DB_NAME = 'photo-album-db';
const DB_VER = 1;
let dbPromise;

function openDB(){
  if (dbPromise) return dbPromise;
  dbPromise = new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const db = req.result;
      if (!db.objectStoreNames.contains('albums')){
        const st = db.createObjectStore('albums', {keyPath:'id'});
        st.createIndex('name','name',{unique:false});
      }
      if (!db.objectStoreNames.contains('photos')){
        const st = db.createObjectStore('photos', {keyPath:'id'});
        st.createIndex('album','album',{unique:false});
        st.createIndex('createdAt','createdAt',{unique:false});
        st.createIndex('name','name',{unique:false});
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
  return dbPromise;
}

const txWrap = async (storeName, mode, fn)=>{
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(storeName, mode);
    const st = tx.objectStore(storeName);
    Promise.resolve(fn(st, tx)).then(()=>{
      tx.oncomplete = ()=> resolve();
      tx.onerror = ()=> reject(tx.error);
    }).catch(reject);
  });
};

// Albums
async function ensureDefaultAlbum(){
  const db = await openDB();
  return new Promise((resolve)=>{
    const tx = db.transaction('albums','readwrite');
    const st = tx.objectStore('albums');
    const req = st.get('default');
    req.onsuccess = ()=>{
      if (!req.result){
        st.put({id:'default', name:'General', createdAt: Date.now()});
      }
    };
    tx.oncomplete = ()=> resolve();
  });
}
async function listAlbums(){
  const db = await openDB();
  return new Promise((resolve)=>{
    const tx = db.transaction('albums');
    const st = tx.objectStore('albums');
    const req = st.getAll();
    req.onsuccess = ()=> resolve(req.result.sort((a,b)=> a.name.localeCompare(b.name)));
  });
}
async function createAlbum(name){
  const id = crypto.randomUUID();
  await txWrap('albums','readwrite', (st)=> st.put({id, name, createdAt: Date.now()}));
  return id;
}

// Photos
async function addPhotos(files, album){
  for (const file of files){
    if (!file.type.startsWith('image/')) continue;
    const {blob, thumb, width, height} = await makeThumb(file);
    const id = crypto.randomUUID();
    const doc = { id, album, name: file.name.replace(/\.[^.]+$/,''), createdAt: Date.now(), tags:[], width, height, blob, thumb };
    await txWrap('photos','readwrite', (st)=> st.put(doc));
  }
}
async function getPhotos({album, search, sort='newest'}){
  const db = await openDB();
  return new Promise((resolve)=>{
    const tx = db.transaction('photos');
    const st = tx.objectStore('photos');
    const req = st.getAll();
    req.onsuccess = ()=>{
      let rows = req.result;
      if (album) rows = rows.filter(p=> p.album===album);
      if (search){
        const q = search.toLowerCase();
        rows = rows.filter(p=> p.name.toLowerCase().includes(q) || (p.tags||[]).join(',').toLowerCase().includes(q));
      }
      if (sort==='newest') rows.sort((a,b)=> b.createdAt - a.createdAt);
      if (sort==='oldest') rows.sort((a,b)=> a.createdAt - b.createdAt);
      if (sort==='name') rows.sort((a,b)=> a.name.localeCompare(b.name));
      resolve(rows);
    };
  });
}
async function getPhoto(id){
  const db = await openDB();
  return new Promise((resolve)=>{
    const tx = db.transaction('photos');
    const st = tx.objectStore('photos');
    const req = st.get(id); req.onsuccess = ()=> resolve(req.result);
  });
}
async function updatePhoto(id, patch){
  const p = await getPhoto(id);
  await txWrap('photos','readwrite', (st)=> st.put({...p, ...patch}));
}
async function deletePhoto(id){
  await txWrap('photos','readwrite', (st)=> st.delete(id));
}

// Thumbnails
function bitmapToBlob(bitmap, type='image/jpeg', quality=.9){
  return new Promise((resolve)=>{
    const canvas = document.createElement('canvas');
    canvas.width = bitmap.width; canvas.height = bitmap.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(bitmap, 0, 0);
    canvas.toBlob(resolve, type, quality);
  });
}
async function makeThumb(file){
  const bmp = await createImageBitmap(file);
  const maxSide = 480;
  const scale = Math.min(1, maxSide/Math.max(bmp.width, bmp.height));
  const w = Math.round(bmp.width * scale);
  const h = Math.round(bmp.height * scale);
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(bmp, 0, 0, w, h);
  const thumb = canvas.toDataURL('image/jpeg', .8);
  const blob = await bitmapToBlob(bmp, file.type.startsWith('image/png')? 'image/png' : 'image/jpeg', .92);
  return {blob, thumb, width:bmp.width, height:bmp.height};
}

// ======= UI L√≥gica =======
let state = { albums: [], currentAlbum: 'default', photos: [], current: null };

async function init(){
  await ensureDefaultAlbum();
  state.albums = await listAlbums();
  if (!state.albums.find(a=>a.id==='default')){ // seguridad
    await txWrap('albums','readwrite', (st)=> st.put({id:'default', name:'General', createdAt: Date.now()}));
    state.albums = await listAlbums();
  }
  renderAlbums();
  await refreshPhotos();
}

function renderAlbums(){
  const list = $('#album-list'); list.innerHTML = '';
  for (const a of state.albums){
    const count = 0; // lo llenamos despu√©s
    const el = document.createElement('div');
    el.className = 'album'+(a.id===state.currentAlbum?' active':'');
    el.innerHTML = `<span class="name">${a.name}</span><small data-count="${a.id}">‚Ä¶</small>`;
    el.onclick = ()=>{ state.currentAlbum = a.id; refreshPhotos(); renderAlbums(); };
    list.appendChild(el);
  }
  // actualizar contadores
  getPhotos({album:null}).then(rows=>{
    const byAlbum = rows.reduce((acc,p)=>{acc[p.album]=(acc[p.album]||0)+1; return acc;},{});
    for (const a of state.albums){
      const el = list.querySelector(`small[data-count="${a.id}"]`);
      if (el) el.textContent = byAlbum[a.id]||0;
    }
  });
  // llenar select del editor
  const sel = $('#edit-album'); sel.innerHTML='';
  for (const a of state.albums){
    const opt = document.createElement('option'); opt.value=a.id; opt.textContent=a.name; sel.appendChild(opt);
  }
}

async function refreshPhotos(){
  const q = $('#search').value.trim();
  const sort = $('#sort').value;
  state.photos = await getPhotos({album: state.currentAlbum, search:q, sort});
  const grid = $('#grid'); grid.innerHTML='';
  $('#empty').style.display = state.photos.length? 'none':'block';
  for (const p of state.photos){
    const card = document.createElement('div');
    card.className = 'card';
    const img = document.createElement('img'); img.src = p.thumb; img.alt = p.name; img.className = 'thumb';
    const meta = document.createElement('div'); meta.className='meta';
    const date = new Date(p.createdAt).toLocaleDateString();
    const tag = (p.tags && p.tags[0])? `#${p.tags[0]}` : `${p.width}√ó${p.height}`;
    meta.innerHTML = `<span class="chip">${date}</span><span class="chip">${tag}</span>`;
    card.appendChild(img); card.appendChild(meta);
    card.onclick = ()=> openViewer(p.id);
    grid.appendChild(card);
  }
}

async function openViewer(id){
  state.current = await getPhoto(id);
  const p = state.current;
  const url = URL.createObjectURL(p.blob);
  $('#viewer-img').src = url;
  $('#edit-name').value = p.name||'';
  $('#edit-tags').value = (p.tags||[]).join(', ');
  $('#edit-album').value = p.album;
  $('#meta').textContent = `${p.width}√ó${p.height} ¬∑ ${new Date(p.createdAt).toLocaleString()}`;
  $('#viewer').showModal();
}

// ======= Eventos =======
$('#btn-add').onclick = ()=> $('#file-input').click();
$('#file-input').onchange = async (e)=>{
  const files = Array.from(e.target.files);
  await addPhotos(files, state.currentAlbum);
  await refreshPhotos(); renderAlbums();
  e.target.value = '';
};

// Drag & drop
const dz = $('#dropzone');
['dragenter','dragover'].forEach(ev=> dz.addEventListener(ev, (e)=>{e.preventDefault(); dz.classList.add('dragover');}));
['dragleave','drop'].forEach(ev=> dz.addEventListener(ev, (e)=>{e.preventDefault(); dz.classList.remove('dragover');}));
dz.addEventListener('drop', async (e)=>{
  const files = Array.from(e.dataTransfer.files);
  await addPhotos(files, state.currentAlbum);
  await refreshPhotos(); renderAlbums();
});

// Crear √°lbum
$('#create-album').onclick = async ()=>{
  const name = $('#new-album-name').value.trim();
  if (!name) return;
  const id = await createAlbum(name);
  state.albums = await listAlbums();
  state.currentAlbum = id;
  $('#new-album-name').value='';
  renderAlbums();
  await refreshPhotos();
};

// Buscar / ordenar
$('#search').oninput = ()=> refreshPhotos();
$('#sort').onchange = ()=> refreshPhotos();

// Viewer actions
$('#prev').onclick = ()=> navViewer(-1);
$('#next').onclick = ()=> navViewer(1);
$('#save').onclick = async ()=>{
  const name = $('#edit-name').value.trim();
  const tags = $('#edit-tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  const album = $('#edit-album').value;
  await updatePhoto(state.current.id, {name, tags, album});
  await refreshPhotos(); renderAlbums();
  toast('Guardado');
};
$('#delete').onclick = async ()=>{
  if (!confirm('¬øEliminar esta foto?')) return;
  await deletePhoto(state.current.id);
  $('#viewer').close();
  await refreshPhotos(); renderAlbums();
};
$('#download').onclick = async ()=>{
  const p = await getPhoto(state.current.id);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(p.blob);
  a.download = (p.name||'foto') + '.jpg';
  document.body.appendChild(a); a.click(); a.remove();
};
function navViewer(dir){
  if (!state.current) return;
  const i = state.photos.findIndex(x=> x.id===state.current.id);
  let j = i + dir; if (j<0) j=state.photos.length-1; if (j>=state.photos.length) j=0;
  openViewer(state.photos[j].id);
}

// Export / Import
$('#btn-export').onclick = async ()=>{
  const db = await openDB();
  const dump = {albums:[], photos:[]};
  await new Promise((res)=>{
    const tx = db.transaction('albums');
    tx.objectStore('albums').getAll().onsuccess = (e)=>{ dump.albums = e.target.result; res(); };
  });
  const photos = await new Promise((res)=>{
    const tx = db.transaction('photos');
    tx.objectStore('photos').getAll().onsuccess = (e)=> res(e.target.result);
  });
  // Convertir blobs a dataURL
  const toDataURL = (blob)=> new Promise((res)=>{ const r = new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); });
  for (const p of photos){
    dump.photos.push({...p, blob: await toDataURL(p.blob)});
  }
  const json = JSON.stringify(dump);
  const file = new Blob([json], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(file); a.download = 'album-respaldo.json'; a.click(); a.remove();
};

$('#import-input').onchange = async (e)=>{
  const file = e.target.files[0]; if (!file) return;
  const text = await file.text();
  try{
    const dump = JSON.parse(text);
    // limpiar y restaurar
    await txWrap('albums','readwrite', (st)=>{
      st.clear();
      for (const a of dump.albums) st.put(a);
    });
    await txWrap('photos','readwrite', (st)=>{
      st.clear();
      for (const p of dump.photos){
        const blob = dataURLToBlob(p.blob);
        const {blob:_, ...rest} = p;
        st.put({...rest, blob});
      }
    });
    state.albums = await listAlbums();
    renderAlbums(); await refreshPhotos();
    alert('Importaci√≥n completada.');
  }catch(err){
    alert('No se pudo importar el archivo.');
  }
  e.target.value='';
};

function dataURLToBlob(dataURL){
  const [meta, b64] = dataURL.split(',');
  const mime = /data:(.*?);/i.exec(meta)[1];
  const bin = atob(b64);
  const arr = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
  return new Blob([arr], {type:mime});
}

// Borrar todo
$('#clear-all').onclick = async (e)=>{
  e.preventDefault();
  if (!confirm('Esto eliminar√° TODOS los √°lbumes y fotos guardados en este navegador. ¬øContinuar?')) return;
  const db = await openDB();
  await new Promise((res)=>{ const tx = db.transaction('albums','readwrite'); tx.objectStore('albums').clear(); tx.oncomplete=()=>res(); });
  await new Promise((res)=>{ const tx = db.transaction('photos','readwrite'); tx.objectStore('photos').clear(); tx.oncomplete=()=>res(); });
  await ensureDefaultAlbum();
  state.albums = await listAlbums();
  state.currentAlbum = 'default';
  renderAlbums(); await refreshPhotos();
};

// Iniciar
init();
</script>
</body>
</html>
