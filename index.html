<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√Ålbum en Firebase</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1rem; background: #f3f4f6; }
    header { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; }
    #albumList, #photoGrid { margin-top: 1rem; }
    .photo-card { background: white; border-radius: 8px; padding: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .photo-card img { max-width: 100%; border-radius: 6px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
    .controls { margin: 1rem 0; }
    button { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; background: #2563eb; color: white; }
    button:hover { background: #1d4ed8; }
  </style>
</head>
<body>
  <header>üì∑ √Ålbum en Firebase</header>

  <section class="controls">
    <input type="file" id="fileInput" multiple />
    <input type="text" id="albumInput" placeholder="Nombre del √°lbum" />
    <button id="uploadBtn">Subir fotos</button>
  </section>

  <section id="albumList">
    <h3>Fotos subidas:</h3>
    <div id="photoGrid" class="grid"></div>
  </section>

  <script type="module">
    // Importar Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // Configuraci√≥n de tu proyecto
    const firebaseConfig = {
      apiKey: "AIzaSyAQHwo1RwucIRAIlqpo3GgRJNmnQlXoNDM",
      authDomain: "album-bc4e1.firebaseapp.com",
      projectId: "album-bc4e1",
      storageBucket: "album-bc4e1.firebasestorage.app",
      messagingSenderId: "1041635546059",
      appId: "1:1041635546059:web:79ff3e516a50b5190ddc4e",
      measurementId: "G-RWGW4F6JCT"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getFirestore(app);

    const fileInput = document.getElementById("fileInput");
    const albumInput = document.getElementById("albumInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const photoGrid = document.getElementById("photoGrid");

    // Subir fotos a Firebase Storage y guardar metadata en Firestore
    async function uploadPhotos() {
      const files = fileInput.files;
      const album = albumInput.value || "general";

      for (const file of files) {
        const id = crypto.randomUUID();
        const storageRef = ref(storage, `albums/${album}/${id}-${file.name}`);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);

        await addDoc(collection(db, "photos"), {
          id,
          album,
          name: file.name.replace(/\.[^.]+$/, ''),
          createdAt: Date.now(),
          url
        });
      }
      await loadPhotos();
    }

    // Cargar fotos desde Firestore
    async function loadPhotos() {
      photoGrid.innerHTML = "";
      const snapshot = await getDocs(collection(db, "photos"));
      const photos = snapshot.docs.map(d => d.data());
      photos.sort((a, b) => b.createdAt - a.createdAt);

      for (const p of photos) {
        const card = document.createElement("div");
        card.className = "photo-card";
        card.innerHTML = `
          <img src="${p.url}" alt="${p.name}">
          <p><b>${p.name}</b></p>
          <small>√Ålbum: ${p.album}</small><br>
          <button data-id="${p.id}" data-album="${p.album}" data-name="${p.name}">Eliminar</button>
        `;
        card.querySelector("button").addEventListener("click", () => deletePhoto(p.id, p.album, p.name));
        photoGrid.appendChild(card);
      }
    }

    // Eliminar foto
    async function deletePhoto(id, album, name) {
      // Borrar Firestore
      const snapshot = await getDocs(collection(db, "photos"));
      const docRef = snapshot.docs.find(d => d.data().id === id);
      if (docRef) await deleteDoc(doc(db, "photos", docRef.id));

      // Borrar de Storage
      const storageRef = ref(storage, `albums/${album}/${id}-${name}`);
      await deleteObject(storageRef);

      await loadPhotos();
    }

    uploadBtn.addEventListener("click", uploadPhotos);

    // Cargar fotos al iniciar
    loadPhotos();
  </script>
</body>
</html>
